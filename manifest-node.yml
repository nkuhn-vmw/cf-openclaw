# Cloud Foundry manifest for OpenClaw Node
# A node provides system.run/system.which capabilities to the gateway
#
# Deploy with: cf push -f manifest-node.yml
#
# Prerequisites:
#   1. Gateway must be running (cf push -f manifest-buildpack.yml)
#   2. Add network policy: cf add-network-policy openclaw-node openclaw --port 8081 --protocol tcp
#   3. Set the gateway token: cf set-env openclaw-node OPENCLAW_GATEWAY_TOKEN <token>
#      (Get the token from: cf logs openclaw --recent | grep "Token:")
---
applications:
  - name: openclaw-node
    memory: 1G
    disk_quota: 4G
    instances: 1

    buildpacks:
      - nodejs_buildpack

    command: bash start-node.sh

    env:
      NODE_ENV: production
      # Gateway connection - uses internal CF networking
      OPENCLAW_GATEWAY_HOST: openclaw.apps.internal
      OPENCLAW_GATEWAY_PORT: "8081"
      # OPENCLAW_GATEWAY_TOKEN: (set via cf set-env - required!)
      # Node display name (instance index auto-appended in seed mode)
      OPENCLAW_NODE_NAME: "cf-node"
      # --- Device Identity for Auto-Pairing ---
      # Option 1 (recommended): Shared seed - must match gateway's OPENCLAW_NODE_SEED
      # Supports multi-instance: cf scale openclaw-node -i N
      # Each instance derives a unique keypair from seed + CF_INSTANCE_INDEX
      # OPENCLAW_NODE_SEED: (set via cf set-env - same value as gateway)
      #
      # Option 2 (legacy): Explicit PEM keypair
      # OPENCLAW_NODE_DEVICE_PUBLIC_KEY: (set via cf set-env)
      # OPENCLAW_NODE_DEVICE_PRIVATE_KEY: (set via cf set-env)

    routes:
      # No external routes needed - node only connects outbound to gateway
      - route: openclaw-node.apps.internal

    health-check-type: process
    timeout: 120

    # No services needed - node connects to gateway only

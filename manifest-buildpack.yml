# Cloud Foundry buildpack deployment manifest for OpenClaw
# Deploy with: cf push -f manifest-buildpack.yml
#
# Prerequisites:
#   1. Clone and build OpenClaw: pnpm install && pnpm build && pnpm ui:build
#   2. Copy these deployment files into the OpenClaw directory
#   3. Create a GenAI service: cf create-service genai <plan> openclaw-genai
---
applications:
  - name: openclaw
    memory: 2G
    disk_quota: 4G
    instances: 1

    buildpacks:
      - nodejs_buildpack

    # start.sh handles S3 sync lifecycle (if bound) or direct startup
    command: bash start.sh

    env:
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=1536"
      # Required for build
      OPENCLAW_PREFER_PNPM: "1"
      OPENCLAW_A2UI_SKIP_MISSING: "1"
      # State directory
      OPENCLAW_STATE_DIR: /home/vcap/app/data
      # --- Version Pinning ---
      # Warn if OpenClaw version changes (protects paired.json format assumptions)
      # OPENCLAW_PINNED_VERSION: "2026.1.29"

      # --- Gateway Authentication ---
      # Set a fixed token for connecting clients.
      # If not set, a random token is auto-generated on each startup (check cf logs).
      # OPENCLAW_GATEWAY_TOKEN: (set via cf set-env openclaw OPENCLAW_GATEWAY_TOKEN <token>)

      # --- Manual API Keys (alternative to GenAI service) ---
      # ANTHROPIC_API_KEY: (set via cf set-env)
      # OPENAI_API_KEY: (set via cf set-env)

      # --- Node Auto-Pairing ---
      # Option 1 (recommended): Shared seed - set on BOTH gateway and node.
      # Derives Ed25519 keypair deterministically. Supports multi-instance scaling.
      #   cf set-env openclaw OPENCLAW_NODE_SEED "$(openssl rand -hex 16)"
      #   cf set-env openclaw-node OPENCLAW_NODE_SEED "<same value as above>"
      # OPENCLAW_NODE_SEED: (set via cf set-env on both gateway and node)
      # OPENCLAW_NODE_MAX_INSTANCES: "1"  # Pre-register N instance keypairs for scaling
      #
      # Option 2 (legacy): Explicit PEM keypair
      #   node -e "const c=require('crypto');const k=c.generateKeyPairSync('ed25519');console.log(k.publicKey.export({type:'spki',format:'pem'}));console.log(k.privateKey.export({type:'pkcs8',format:'pem'}))"
      #   cf set-env openclaw OPENCLAW_NODE_DEVICE_PUBLIC_KEY "-----BEGIN PUBLIC KEY-----..."
      #   cf set-env openclaw-node OPENCLAW_NODE_DEVICE_PUBLIC_KEY "-----BEGIN PUBLIC KEY-----..."
      #   cf set-env openclaw-node OPENCLAW_NODE_DEVICE_PRIVATE_KEY "-----BEGIN PRIVATE KEY-----..."
      # OPENCLAW_NODE_DEVICE_PUBLIC_KEY: (set via cf set-env)
      OPENCLAW_NODE_DEVICE_NAME: "cf-node"

    routes:
      - route: openclaw.apps.tas-tdc.kuhn-labs.com

    health-check-type: http
    health-check-http-endpoint: /
    timeout: 300

    services:
      - tanzu-all-models
      # - openclaw-secrets  # User-provided service with gateway_token, node_seed
      # - openclaw-storage  # S3-compatible object storage for persistent state
